package boundary;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Date;
import control.BookController;
import control.ClientMain;
import entity.Book;
import entity.ConstantsAndGlobalVars;
import entity.MyFile;
import enums.BookType;
import javafx.application.HostServices;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.Alert;
import javafx.scene.control.Alert.AlertType;
import javafx.scene.control.ButtonBar.ButtonData;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Label;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.image.ImageView;
import javafx.stage.DirectoryChooser;
import javafx.stage.FileChooser;
import javafx.stage.Stage;

/**
 * @see boundary.AddBookController very similar to AddBookController, with the
 *      addition of the ability to download the table of contents file or upload
 *      a new one.
 */
public class EditBookController {
	/**
	 * instance variables: bookController - an instance of BookController to use
	 * when saving changes. currentBook - the book being edited. filePath - the
	 * download destination for the table of contents file.
	 */
	private BookController bookController;
	private Book currentBook;
	private String filePath;
	private final String uploadTitle = "upload a new file";
	private final String canacelUpload = "cancel";
	private final String addNewCategoryBtnTitle = "Add New Category";
	private final String cancelBtnTitle = "Cancel";
	@FXML
	private Label catalogNumberLabel;

	@FXML
	private TextField titleTF;

	@FXML
	private TextField authorNameTF;

	@FXML
	private TextField publicationTF;

	@FXML
	private TextField numberOfCopiesTF;

	@FXML
	private DatePicker purchaseDateDP;

	@FXML
	private TextField shelfNumberTF;

	@FXML
	private TextField sideTF;

	@FXML
	private TextArea descriptionTA;

	@FXML
	private ComboBox typeCB;
	private ObservableList<String> bookTypesList;

	@FXML
	private TextField destTF;

	@FXML
	private Button saveBookBtn;

	@FXML
	private Button cancelBtn;

	@FXML
	private Button dirBrowseButton;

	@FXML
	private ImageView oblImg;

	@FXML
	private Button downloadFileButton;

	@FXML
	private Button viewFileButton;

	@FXML
	private Button FileBrowserButton;

	@FXML
	private TextField tableOfContentsFilePathTF;

	@FXML
	private Button uploadNewButton;

	@FXML
	private ComboBox<String> categoriesComboBox;
	private ObservableList<String> categoryList;

	@FXML
	private Button addCategoryBtn;

	@FXML
	private TextField newCategoryTF;

	@FXML
	private Button addNewCategoryBtn;

	@FXML
	private Button show_hide_newCategoryPromptBtn;

	@FXML
	private TextArea categoriesTA;

	/**
	 * @see boundary.AddBookController#show_hide_newCategoryPromptHandler(ActionEvent)
	 * @param event - auto-generated by SceneBuilder.
	 */
	@FXML
	void show_hide_newCategoryPromptHandler(ActionEvent event) {
		if (show_hide_newCategoryPromptBtn.getText().equals(addNewCategoryBtnTitle)) {
			newCategoryTF.setVisible(true);
			addNewCategoryBtn.setVisible(true);
			show_hide_newCategoryPromptBtn.setText(cancelBtnTitle);
		} else {
			newCategoryTF.setVisible(false);
			addNewCategoryBtn.setVisible(false);
			show_hide_newCategoryPromptBtn.setText(addNewCategoryBtnTitle);
		}
	}

	/**
	 * @see boundary.AddBookController#addCategoryHandler(ActionEvent)
	 * @param event - auto-generated by SceneBuilder.
	 */
	@FXML
	void addCategoryHandler(ActionEvent event) {
		try {
			String category = categoriesComboBox.getSelectionModel().getSelectedItem();
			if (category == null)
				throw new ArrayIndexOutOfBoundsException();
			categoryList.remove(category);
			categoriesComboBox.setItems(categoryList);
			categoriesTA.setText(categoriesTA.getText() + category + ",");
		} catch (ArrayIndexOutOfBoundsException e) {
			Alert alert = new Alert(AlertType.ERROR);
			alert.setTitle("Whoa!");
			alert.setHeaderText("Please choose an  item from the list");
			ButtonType buttonTypeCancel = new ButtonType("Ok", ButtonData.CANCEL_CLOSE);
			alert.getButtonTypes().setAll(buttonTypeCancel);
			alert.showAndWait();
		}
	}

	/**
	 * @see boundary.AddBookController#addNewCategoryHandler(ActionEvent)
	 * @param event - auto-generated by SceneBuilder.
	 */
	@FXML
	void addNewCategoryHandler(ActionEvent event) {
		if (!newCategoryTF.getText().isEmpty())
			categoriesTA.setText(categoriesTA.getText() + newCategoryTF.getText() + ",");
		else {
			Alert alert = new Alert(AlertType.ERROR);
			alert.setTitle("Whoa!");
			alert.setHeaderText("At least type something...");
			ButtonType buttonTypeCancel = new ButtonType("Ok", ButtonData.CANCEL_CLOSE);
			alert.getButtonTypes().setAll(buttonTypeCancel);
			alert.showAndWait();
		}
	}

	/**
	 * @see boundary.AddBookController#BrowseTableOfContentsFileHandler(ActionEvent)
	 * @param event - auto-generated by SceneBuilder.
	 */
	@FXML
	void BrowseFileHandler(ActionEvent event) {
		tableOfContentsFilePathTF.setStyle("-fx-border-color: transparent; -fx-text-fill: black;");
		tableOfContentsFilePathTF.setText("");
		tableOfContentsFilePathTF.setPromptText("Choose file path");
		Stage stage = (Stage) FileBrowserButton.getScene().getWindow();
		FileChooser fc = new FileChooser();
		fc.setTitle("Open PDF file...");
		fc.getExtensionFilters().add(new FileChooser.ExtensionFilter("PDF Files", "*.pdf"));
		File file = fc.showOpenDialog(stage.getOwner());
		if (file != null) {
			String filename = file.getAbsolutePath();
			tableOfContentsFilePathTF.setText(filename);
		} else {
			tableOfContentsFilePathTF.setStyle("-fx-text-fill: red; -fx-border-color: red;");
			tableOfContentsFilePathTF.setText("Please provide file path");
		}
	}

	/**
	 * This method shows/hides the GUI elements responsible for enabling the user to
	 * upload a file.
	 * 
	 * @param event - auto-generated by SceneBuilder.
	 */
	@FXML
	void UploadNewHandler(ActionEvent event) {
		if (uploadNewButton.getText().equals(uploadTitle)) {
			tableOfContentsFilePathTF.setVisible(true);
			FileBrowserButton.setVisible(true);
			uploadNewButton.setText(canacelUpload);
			return;
		}
		if (uploadNewButton.getText().equals(canacelUpload)) {
			tableOfContentsFilePathTF.setVisible(false);
			FileBrowserButton.setVisible(false);
			uploadNewButton.setText(uploadTitle);
			return;
		}
	}

	/**
	 * @see boundary.BookDetailsController#dirBrowseHandler(ActionEvent)
	 * @param event
	 */
	@FXML
	void BrowseDownloadDestinationHandler(ActionEvent event) {
		// change textField style to default.
		destTF.setStyle("-fx-text-fill: black; -fx-border-color: transparent;");
		destTF.setPromptText("Choose download path");
		// open a directory chooser to choose download path
		Stage stage = (Stage) dirBrowseButton.getScene().getWindow();
		DirectoryChooser chooser = new DirectoryChooser();
		chooser.setTitle("Choose Download Destination");
		File selectedDirectory = chooser.showDialog(stage);
		if (selectedDirectory != null) {
			String dest = selectedDirectory.getAbsolutePath();
			destTF.setText(dest);
		}
		// if user didn't choose, provide feedback and display error message
		if (destTF.getText().isEmpty()) {
			destTF.setStyle("-fx-text-fill: red; -fx-border-color: red;");
			destTF.setText("Please provide download path");
		}
	}

	/**
	 * @see boundary.AddBookController#cancelHandler(ActionEvent)
	 * @param event - auto-generated by SceneBuilder
	 * @throws IOException - thrown if loading the FXML file fails.
	 */
	@FXML
	void cancelHandler(ActionEvent event) throws IOException {
		Stage primaryStage = (Stage) cancelBtn.getScene().getWindow();
		FXMLLoader loader = new FXMLLoader();
		Parent root = loader.load(getClass().getResource("/boundary/InventoryManagementGUI.fxml").openStream());
		primaryStage.setScene(new Scene(root));
		primaryStage.setTitle("Inventory Management");
		primaryStage.show();
	}

	/**
	 * @see boundary.BookDetailsController#downloadFileHandler(ActionEvent)
	 * @param event - auto-generated by SceneBuilder.
	 */
	@FXML
	void downloadHandler(ActionEvent event) {
		// change textField style back to default
		destTF.setStyle("-fx-text-fill: black; -fx-border-color: transparent;");
		destTF.setPromptText("Choose download path");
		// check if user didn't choose a destination directory
		if (destTF.getText().isEmpty()) {
			destTF.setStyle("-fx-text-fill: red; -fx-border-color: red;");
			destTF.setText("Please provide download path");
			return;
		}
		// get the byte array from the current book
		byte[] arr = this.currentBook.getTableOfContents().getMybytearray();
		// get the absolute download path
		filePath = destTF.getText() + "\\" + this.currentBook.getTableOfContents().getFileName();
		// create a new file from the byte array and open it in the destination path
		try {
			// create the file using a FileOutputStream
			FileOutputStream fos = new FileOutputStream(filePath);
			fos.write(arr);
			fos.close();// close the resource
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
		// set the view file button to visible
		viewFileButton.setVisible(true);
	}

	/**
	 * This method saves any changes made to the book being edited. It validates all
	 * fields are not empty, uploads the file chosen by the user (if applicable) and
	 * calls the {@link control.BookController#updateBook(Book)} method to update
	 * the book.
	 * 
	 * @param event - auto-generated by SceneBuilder.
	 * @throws IOException - thrown if writing the file to a byte array fails.
	 */
	@FXML
	void saveBookHandler(ActionEvent event) throws IOException {
		boolean isOk = true;
		if (titleTF.getText().isEmpty())
			isOk = false;
		if (authorNameTF.getText().isEmpty())
			isOk = false;
		if (publicationTF.getText().isEmpty())
			isOk = false;
		if (purchaseDateDP.getValue() == null)
			isOk = false;
		if (shelfNumberTF.getText().isEmpty())
			isOk = false;
		if (sideTF.getText().isEmpty())
			isOk = false;
		if (descriptionTA.getText().isEmpty())
			isOk = false;
		if (tableOfContentsFilePathTF.isVisible() && tableOfContentsFilePathTF.getText().isEmpty())
			isOk = false;
		if (!isOk) {
			Alert alert = new Alert(AlertType.ERROR);
			alert.setTitle("OOPS!");
			alert.setHeaderText("One or more of the fields is empty.");
			ButtonType buttonTypeCancel = new ButtonType("Ok", ButtonData.CANCEL_CLOSE);
			alert.getButtonTypes().setAll(buttonTypeCancel);
			alert.showAndWait();
			return;
		}
		/*
		 * validate that each element is not empty.
		 */
		try {
			String catalogNumber = catalogNumberLabel.getText();
			String title = titleTF.getText();
			String author = authorNameTF.getText();
			String publication = publicationTF.getText();
			int numberOfCopies = Integer.parseInt(numberOfCopiesTF.getText());
			LocalDate purchaseDate_ld = purchaseDateDP.getValue();
			String locationOnShelf = shelfNumberTF.getText() + sideTF.getText();
			String description = descriptionTA.getText();
			enums.BookType booktype = enums.BookType
					.valueOf(bookTypesList.get(typeCB.getSelectionModel().getSelectedIndex()));
			// if the librarian chose a new file upload it, otherwise use the old one.
			MyFile fileToUpload = this.currentBook.getTableOfContents();
			if (tableOfContentsFilePathTF.isVisible()) {
				String filePath = tableOfContentsFilePathTF.getText();

				File newFile = new File(filePath);// open the file
				// convert the file to a MyFile object so it can be sent to the server.
				// i.e. set the byte array, set the size, the name, etc.
				fileToUpload = new MyFile(newFile.getName());// instantiate a new MyFile object with the files' name
				// Initialise the byte array
				fileToUpload.initArray((int) newFile.length());
				// set the file size attribute
				fileToUpload.setSize((int) newFile.length());
				fileToUpload.setDescription(title + "Table of contents");
				// a temp byte array
				byte[] mybytearray = new byte[(int) newFile.length()];
				// copy the byte array from newFile to fileToUpload byte array.
				FileInputStream fis = new FileInputStream(newFile);
				BufferedInputStream bis = new BufferedInputStream(fis);
				bis.read(fileToUpload.getMybytearray(), 0, mybytearray.length);
				// close the streams so the file won't be in use.
				bis.close();
				fis.close();
			}

			SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
			Date purchaseDate = Date.from(purchaseDate_ld.atStartOfDay(ZoneId.systemDefault()).toInstant());
			format.format(purchaseDate);
			Book book = new Book(catalogNumber, title, author, publication, numberOfCopies, purchaseDate,
					locationOnShelf, fileToUpload, description, booktype);
			if (bookController.updateBook(book)) {
				Alert alert = new Alert(AlertType.CONFIRMATION, "Book updated successfully", ButtonType.OK);
				alert.showAndWait();
				if (alert.getResult() == ButtonType.OK) {
					Stage primaryStage = (Stage) saveBookBtn.getScene().getWindow();
					FXMLLoader loader = new FXMLLoader();
					Parent root = loader
							.load(getClass().getResource("/boundary/InventoryManagementGUI.fxml").openStream());
					primaryStage.setScene(new Scene(root));
					primaryStage.setTitle("Inventory Management");
					primaryStage.show();
				}
			} else {
				Alert alert = new Alert(AlertType.ERROR, "Failure updating book", ButtonType.OK);
				alert.showAndWait();
				if (alert.getResult() == ButtonType.OK) {
					Stage primaryStage = (Stage) saveBookBtn.getScene().getWindow();
					FXMLLoader loader = new FXMLLoader();
					Parent root = loader
							.load(getClass().getResource("/boundary/InventoryManagementGUI.fxml").openStream());
					primaryStage.setScene(new Scene(root));
					primaryStage.setTitle("Inventory Management");
					primaryStage.show();
				}
			}
		} catch (IOException e) {
			e.printStackTrace();
		} catch (NumberFormatException n) {
			Alert alert = new Alert(AlertType.ERROR);
			alert.setTitle("Failure!");
			alert.setHeaderText("Please enter numbers only in number of copies field..");
			ButtonType buttonTypeCancel = new ButtonType("Ok", ButtonData.CANCEL_CLOSE);
			alert.getButtonTypes().setAll(buttonTypeCancel);
			alert.showAndWait();
		}

	}

	/**
	 * @see boundary.BookDetailsController#viewFileHandler(ActionEvent)
	 * @param event
	 */
	@FXML
	void viewFileHandler(ActionEvent event) {
		// open the file
		File file = new File(filePath);
		// view it using host services
		HostServices hostServices = ClientMain.myGetHostServices();
		hostServices.showDocument(file.getAbsolutePath());
	}

	/**
	 * @see boundary.AddBookController#initialize()
	 */
	@FXML
	void initialize() {
		bookController = BookController.getInstance(ConstantsAndGlobalVars.ipAddress,
				ConstantsAndGlobalVars.DEFAULT_PORT);
		fillComboBox();
		viewFileButton.setVisible(false);
		tableOfContentsFilePathTF.setVisible(false);
		FileBrowserButton.setVisible(false);
		tableOfContentsFilePathTF.setEditable(false);
		destTF.setEditable(false);
	}

	/**
	 * This {@code private} method is called upon initialisation, it fills the
	 * comboBoxes with their respective values.
	 */
	private void fillComboBox() {
		ArrayList<String> arr = new ArrayList<>();
		for (BookType b : enums.BookType.values())
			arr.add(b.name());
		bookTypesList = FXCollections.observableArrayList(arr);
		typeCB.setItems(bookTypesList);
	}

	/**
	 * @see boundary.BookDetailsController#loadBook(Book)
	 * @param b - the book to edit
	 */
	public void loadBook(Book b) {
		this.currentBook = b;
		System.out.println(this.currentBook);
		catalogNumberLabel.setText(this.currentBook.getCatalogNumber());
		titleTF.setText(this.currentBook.getTitle());
		authorNameTF.setText(this.currentBook.getAuthorName());
		publicationTF.setText(this.currentBook.getPublication());
		numberOfCopiesTF.setText(Integer.toString(this.currentBook.getNumberOfCopies()));
		// convert Date to localDate and display it on DatePicker
		Date input = this.currentBook.getPurchaseDate();
		LocalDate purchaseDate = input.toInstant().atZone(ZoneId.systemDefault()).toLocalDate();
		purchaseDateDP.setValue(purchaseDate);
		String shelfNumber = this.currentBook.getLocationOnShelf().substring(0, 3);
		shelfNumberTF.setText(shelfNumber);
		String shelfSide = this.currentBook.getLocationOnShelf().substring(3, 4);
		sideTF.setText(shelfSide);
		descriptionTA.setText(this.currentBook.getDescription());
		typeCB.getSelectionModel().select(bookTypesList.indexOf(this.currentBook.getType().name()));
		ArrayList<String> categoriesArrayList = this.currentBook.getCategories();
		String text = "";
		for (String string : categoriesArrayList) {
			text = text + string + ",";
		}
		categoriesTA.setText(text);
		ArrayList<String> categories = bookController.getAllCategories();
		categories.removeAll(categoriesArrayList);
		System.out.println(categories);
		categoryList = FXCollections.observableList(categories);
		categoriesComboBox.setItems(categoryList);
		categoriesComboBox.setPromptText("Choose an existing category");
	}
}
